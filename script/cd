#!/usr/bin/env bash

set -e

npm ci
npm run lint
npm run build
npm run release

if [[ -z $(git diff --quiet) ]]; then
  GIT_EMAIL="guardian-ci@users.noreply.github.com"
  GIT_USERNAME="guardian-ci"

  git config --global user.email "$GIT_EMAIL"
  git config --global user.name "$GIT_USERNAME"
  git remote set-url origin "https://git:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

  # semantic-release has bumped the version number
  NEXT_VERSION=$(jq -r '.version' < package.json)
  NEXT_VERSION_BRANCH="release-$NEXT_VERSION"
  MESSAGE="chore(release): $NEXT_VERSION"

  # create new branch
  git checkout -b "$NEXT_VERSION_BRANCH"

  # add changes
  git add package.json

  if [[ -f "package-lock.json" ]]; then
    git add package-lock.json
  elif [[ -f "yarn.lock" ]]; then
    git add yarn.lock
  fi

  git commit -m "$MESSAGE"

  # push branch
  git push -u origin "$NEXT_VERSION_BRANCH"

  # raise PR
  gh pr create --title "$MESSAGE [skip ci]" --body "keeping repository up to date"
fi
